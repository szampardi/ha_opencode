#!/command/with-contenv bashio
# ==============================================================================
# HA OpenCode - Main Service
# ==============================================================================

bashio::log.info "=============================================="
bashio::log.info "  HA OpenCode for Home Assistant"
bashio::log.info "  Starting services..."
bashio::log.info "=============================================="

# Ensure data directories exist
mkdir -p /data/.local/share/opencode
mkdir -p /data/.config/opencode

# ==============================================================================
# Deploy AGENTS.md to Home Assistant config directory (first install only)
# Users can customize this file using File Editor or any text editor
# ==============================================================================

if [ ! -f "/homeassistant/AGENTS.md" ]; then
    cp /opt/ha-mcp-server/AGENTS.md /homeassistant/AGENTS.md
    bashio::log.info "Deployed default AGENTS.md to /homeassistant/"
    bashio::log.info "You can customize AI instructions by editing AGENTS.md"
fi

# ==============================================================================
# Read configuration options
# ==============================================================================

MCP_ENABLED=$(bashio::config 'mcp_enabled')
LSP_ENABLED=$(bashio::config 'lsp_enabled' || echo "true")
SERVE_PRINT_LOGS=$(bashio::config 'serve_print_logs' || echo "true")
SERVE_LOG_LEVEL=$(bashio::config 'serve_log_level' || echo "DEBUG")
SERVE_HOSTNAME=$(bashio::config 'serve_hostname' || echo "0.0.0.0")
SERVE_MDNS=$(bashio::config 'serve_mdns' || echo "false")
OPENCODE_SERVER_PASSWORD=$(bashio::config 'opencode_server_password' || echo "")
OPTIONS_FILE="/data/options.json"
SERVE_PORT=4096
TTYD_PORT=8099

bashio::log.info "Configuration: MCP=${MCP_ENABLED} LSP=${LSP_ENABLED}"

if [ "${OPENCODE_SERVER_PASSWORD}" = "null" ]; then
    OPENCODE_SERVER_PASSWORD=""
fi

if [ -n "${OPENCODE_SERVER_PASSWORD}" ]; then
    export OPENCODE_SERVER_PASSWORD="${OPENCODE_SERVER_PASSWORD}"
else
    unset OPENCODE_SERVER_PASSWORD
fi

# ==============================================================================
# Apply configuration in single jq operation
# ==============================================================================

MCP_BOOL=$([ "${MCP_ENABLED}" = "true" ] && echo "true" || echo "false")
LSP_DISABLED=$([ "${LSP_ENABLED}" = "true" ] && echo "false" || echo "true")

jq --argjson mcp "${MCP_BOOL}" --argjson lsp_disabled "${LSP_DISABLED}" '
    .mcp.homeassistant.enabled = $mcp |
    if $lsp_disabled then .lsp["ha-yaml"].disabled = true else del(.lsp["ha-yaml"].disabled) end
' /opt/ha-mcp-server/opencode-ha.json > /data/.config/opencode/opencode.json

# ==============================================================================
# Inject OpenCode config.json (optional)
# ==============================================================================

if [ -f "${OPTIONS_FILE}" ]; then
    OPENCODE_CONFIG_JSON=$(jq -r '.opencode_config // empty' "${OPTIONS_FILE}")
    if [ -n "${OPENCODE_CONFIG_JSON}" ]; then
        if ! printf '%s' "${OPENCODE_CONFIG_JSON}" | jq -e . >/dev/null 2>&1; then
            bashio::log.error "Invalid JSON in opencode_config"
            exit 1
        fi

        printf '%s' "${OPENCODE_CONFIG_JSON}" > /data/.config/opencode/config.json
        bashio::log.info "Wrote /data/.config/opencode/config.json from add-on config"
    fi
fi

# ==============================================================================
# Set Node.js memory limit (hardcoded for stability)
# ==============================================================================

bashio::log.info "Starting OpenCode server on port ${SERVE_PORT}..."
bashio::log.info "Starting ttyd ingress on port ${TTYD_PORT}..."

# ==============================================================================
# Start OpenCode server and ttyd ingress
# ==============================================================================

SERVE_ARGS=(serve --hostname "${SERVE_HOSTNAME}" --port "${SERVE_PORT}" --log-level "${SERVE_LOG_LEVEL}")

if [ "${SERVE_PRINT_LOGS}" = "true" ]; then
    SERVE_ARGS+=(--print-logs)
fi

if [ "${SERVE_MDNS}" = "true" ]; then
    SERVE_ARGS+=(--mdns)
fi

if [ -f "${OPTIONS_FILE}" ]; then
    SERVE_CORS_TYPE=$(jq -r 'if .serve_cors==null then "null" else (.serve_cors|type) end' "${OPTIONS_FILE}")
    case "${SERVE_CORS_TYPE}" in
        array)
            mapfile -t SERVE_CORS_VALUES < <(jq -r '.serve_cors[] | select(length>0)' "${OPTIONS_FILE}")
            ;;
        string)
            mapfile -t SERVE_CORS_VALUES < <(jq -r '.serve_cors | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length>0))[]' "${OPTIONS_FILE}")
            ;;
        null)
            SERVE_CORS_VALUES=()
            ;;
        *)
            bashio::log.error "Invalid serve_cors value; expected a list or comma-separated string"
            exit 1
            ;;
    esac

    for cors_value in "${SERVE_CORS_VALUES[@]}"; do
        SERVE_ARGS+=(--cors "${cors_value}")
    done
fi

opencode "${SERVE_ARGS[@]}" &
OPENCODE_PID=$!

ttyd \
    -W \
    -p "${TTYD_PORT}" \
    -t fontSize=14 \
    -t cursorBlink=true \
    -t 'theme={"background":"#1e1e2e","foreground":"#cdd6f4","cursor":"#f5e0dc","cursorAccent":"#1e1e2e","selectionBackground":"#585b70","selectionForeground":"#cdd6f4","black":"#45475a","red":"#f38ba8","green":"#a6e3a1","yellow":"#f9e2af","blue":"#89b4fa","magenta":"#f5c2e7","cyan":"#94e2d5","white":"#bac2de","brightBlack":"#585b70","brightRed":"#f38ba8","brightGreen":"#a6e3a1","brightYellow":"#f9e2af","brightBlue":"#89b4fa","brightMagenta":"#f5c2e7","brightCyan":"#94e2d5","brightWhite":"#a6adc8"}' \
    /usr/local/bin/opencode-session.sh &
TTYD_PID=$!

wait -n "${OPENCODE_PID}" "${TTYD_PID}"
STATUS=$?
kill -TERM "${OPENCODE_PID}" "${TTYD_PID}" 2>/dev/null || true
wait "${OPENCODE_PID}" "${TTYD_PID}" 2>/dev/null || true
exit "${STATUS}"
